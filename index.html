<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Student Sync Planner</title>

    <!-- PWA Manifest Embebido (Truco para archivo único) -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiU3R1ZGVudCBTeW5jIiwiU2hvcnRfbmFtZSI6IkFnZW5kYSIs"start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#0ea5e9","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2921/2921222.png","sizes":"192x192","type":"image/png"}]}'>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#0ea5e9', 600:'#0284c7', 900:'#0c4a6e' },
                        magic: { 500:'#8b5cf6', 600:'#7c3aed' }
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .dark .glass-panel { background: rgba(31, 41, 55, 0.9); }
        
        /* Animaciones */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .fade-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Calendario */
        .calendar-day.active { background: #0ea5e9; color: white; transform: scale(1.1); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); }
        .dot { width: 4px; height: 4px; border-radius: 50%; margin: 0 1px; }
        .dot.exam { background: #ef4444; }
        .dot.task { background: #3b82f6; }
        .calendar-day.active .dot { background: white !important; }

        /* Login Overlay */
        #login-overlay { transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen flex flex-col overflow-hidden selection:bg-brand-500 selection:text-white">

    <!-- PANTALLA DE LOGIN (Overlay) -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-white dark:bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-8 relative w-24 h-24 flex items-center justify-center bg-brand-100 dark:bg-gray-800 rounded-3xl shadow-xl animate-float">
            <i class="fa-solid fa-graduation-cap text-4xl text-brand-600"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Student Sync</h1>
        <p class="text-gray-500 mb-10 max-w-xs">Organiza tus exámenes y tareas. Sincronizado en todos tus dispositivos.</p>
        
        <button onclick="loginWithGoogle()" class="flex items-center gap-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 px-6 py-4 rounded-xl shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full max-w-xs justify-center font-bold text-lg relative overflow-hidden group">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
            <span>Entrar con Google</span>
            <div id="login-spinner" class="hidden absolute inset-0 bg-white/80 dark:bg-gray-800/80 flex items-center justify-center">
                <i class="fa-solid fa-circle-notch fa-spin text-brand-600"></i>
            </div>
        </button>
        <p class="mt-8 text-xs text-gray-400">Tus datos se guardan seguros en Firebase</p>
    </div>

    <!-- APP PRINCIPAL (Oculta hasta login) -->
    <div id="app-content" class="flex flex-col h-full hidden opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER -->
        <header class="px-6 py-4 flex justify-between items-center bg-white dark:bg-gray-800 shadow-sm z-10">
            <div class="flex items-center gap-3">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200 hidden" alt="User">
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-brand-600 dark:text-brand-400 leading-none">Mi Agenda</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="sync-status" class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full flex items-center gap-1 font-bold">
                            <i class="fa-solid fa-cloud"></i> Sync
                        </span>
                        <p id="currentDateDisplay" class="text-[10px] text-gray-400 font-medium uppercase tracking-wider">HOY</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- Botón Balanceador de Carga -->
                <button onclick="autoBalanceCalendar()" class="p-2 rounded-full bg-magic-50 text-magic-600 hover:bg-magic-100 transition relative group">
                    <i class="fa-solid fa-wand-sparkles text-lg"></i>
                    <span class="absolute top-full right-0 mt-2 w-32 bg-gray-800 text-white text-[10px] p-2 rounded hidden group-hover:block z-50">Optimizar Carga</span>
                </button>
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i id="theme-icon" class="fa-solid fa-moon text-lg"></i>
                </button>
                <button onclick="logout()" class="p-2 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition">
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </header>

        <!-- CONTENIDO SCROLLABLE -->
        <main class="flex-1 overflow-y-auto no-scrollbar pb-24 relative bg-white dark:bg-gray-900 rounded-t-3xl mt-[-10px] z-0 pt-4">
            
            <!-- Controles Mes -->
            <div class="flex justify-between items-center px-6 mb-4">
                <button id="prevMonth" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fa-solid fa-chevron-left text-sm"></i></button>
                <h2 id="monthYear" class="text-lg font-bold capitalize"></h2>
                <button id="nextMonth" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition"><i class="fa-solid fa-chevron-right text-sm"></i></button>
            </div>

            <!-- Días Semana -->
            <div class="grid grid-cols-7 text-center px-4 mb-2">
                <span class="text-[10px] font-bold text-gray-400">D</span>
                <span class="text-[10px] font-bold text-gray-400">L</span>
                <span class="text-[10px] font-bold text-gray-400">M</span>
                <span class="text-[10px] font-bold text-gray-400">X</span>
                <span class="text-[10px] font-bold text-gray-400">J</span>
                <span class="text-[10px] font-bold text-gray-400">V</span>
                <span class="text-[10px] font-bold text-gray-400">S</span>
            </div>

            <!-- Grid -->
            <div id="calendar-grid" class="grid grid-cols-7 gap-y-2 gap-x-1 px-4 mb-8"></div>

            <!-- Panel Eventos -->
            <div class="bg-gray-50 dark:bg-gray-800/50 min-h-[400px] rounded-t-[2rem] p-6 shadow-inner">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 id="selected-date-title" class="font-bold text-xl dark:text-white">Hoy</h3>
                        <p class="text-xs text-gray-500" id="tasks-subtitle">Tus tareas pendientes</p>
                    </div>
                    <div id="day-load-indicator" class="hidden text-xs px-2 py-1 rounded bg-red-100 text-red-600 font-bold">¡Sobrecarga!</div>
                </div>

                <div id="event-list" class="space-y-3 pb-20">
                    <!-- Eventos aquí -->
                </div>
            </div>
        </main>

        <!-- FAB -->
        <button onclick="openModal()" class="fixed bottom-6 right-6 bg-brand-600 hover:bg-brand-700 text-white w-14 h-14 rounded-full shadow-lg shadow-brand-500/40 flex items-center justify-center text-2xl transition-transform hover:scale-110 active:scale-95 z-40">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- MODAL -->
        <div id="event-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center sm:p-4">
            <div class="bg-white dark:bg-gray-800 w-full sm:max-w-md sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl fade-enter">
                <h3 class="text-xl font-bold mb-6 dark:text-white">Nueva Tarea</h3>
                <form id="event-form" onsubmit="handleSave(event)">
                    <input type="text" id="event-title" required class="w-full bg-gray-100 dark:bg-gray-700 border-0 rounded-xl p-4 mb-4 focus:ring-2 focus:ring-brand-500 dark:text-white outline-none font-medium" placeholder="¿Qué tienes que hacer?">
                    
                    <div class="grid grid-cols-3 gap-2 mb-6">
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="exam" class="peer hidden" checked>
                            <div class="peer-checked:bg-red-500 peer-checked:text-white bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-xl p-3 text-center transition">
                                <i class="fa-solid fa-triangle-exclamation block text-xl mb-1"></i>
                                <span class="text-xs font-bold">Examen</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="homework" class="peer hidden">
                            <div class="peer-checked:bg-blue-500 peer-checked:text-white bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-xl p-3 text-center transition">
                                <i class="fa-solid fa-book block text-xl mb-1"></i>
                                <span class="text-xs font-bold">Tarea</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="study" class="peer hidden">
                            <div class="peer-checked:bg-purple-500 peer-checked:text-white bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-xl p-3 text-center transition">
                                <i class="fa-solid fa-brain block text-xl mb-1"></i>
                                <span class="text-xs font-bold">Estudio</span>
                            </div>
                        </label>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 py-3 rounded-xl font-bold">Cancelar</button>
                        <button type="submit" class="flex-1 bg-brand-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-brand-500/30">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURACIÓN PROPORCIONADA
        const firebaseConfig = {
            apiKey: "AIzaSyDPEsl_dE1fzYkuxemJRvhDxpfvYZfgGZo",
            authDomain: "calendar-1868c.firebaseapp.com",
            projectId: "calendar-1868c",
            storageBucket: "calendar-1868c.firebasestorage.app",
            messagingSenderId: "872239833100",
            appId: "1:872239833100:web:b9059b5f589825f2950e29",
            measurementId: "G-RRR30MYKXW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Estado Global
        let currentUser = null;
        let events = []; // Se mantiene sincronizado con Firestore
        let currentDate = new Date();
        let selectedDate = new Date();
        let unsubscribe = null; // Para detener el listener al salir

        // UI Helpers
        const el = (id) => document.getElementById(id);
        const formatDateKey = (date) => `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;

        // --- AUTHENTICATION ---
        window.loginWithGoogle = async () => {
            el('login-spinner').classList.remove('hidden');
            try {
                await signInWithPopup(auth, provider);
                // El listener onAuthStateChanged manejará la UI
            } catch (error) {
                console.error(error);
                alert("Error al iniciar sesión: " + error.message);
                el('login-spinner').classList.add('hidden');
            }
        };

        window.logout = () => {
            signOut(auth);
            if(unsubscribe) unsubscribe();
            events = [];
            renderCalendar();
            renderEvents();
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const overlay = el('login-overlay');
            const content = el('app-content');

            if (user) {
                // Logged In
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.add('hidden'), 500);
                content.classList.remove('hidden');
                setTimeout(() => content.style.opacity = '1', 100);
                
                el('user-avatar').src = user.photoURL;
                el('user-avatar').classList.remove('hidden');
                
                initFirestoreSync();
            } else {
                // Logged Out
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.style.opacity = '1', 10);
                content.classList.add('hidden');
                content.style.opacity = '0';
                el('login-spinner').classList.add('hidden');
            }
        });

        // --- FIRESTORE SYNC ---
        function initFirestoreSync() {
            if (!currentUser) return;
            
            el('sync-status').innerHTML = '<i class="fa-solid fa-rotate fa-spin"></i> Sync...';
            
            // Referencia: users/{uid}/events
            const q = query(collection(db, `users/${currentUser.uid}/events`));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                events = [];
                snapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                
                el('sync-status').innerHTML = '<i class="fa-solid fa-check"></i> Cloud';
                renderCalendar();
                renderEvents();
            }, (error) => {
                console.error("Error sync:", error);
                el('sync-status').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Error';
            });
        }

        window.handleSave = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const title = el('event-title').value;
            const category = document.querySelector('input[name="category"]:checked').value;
            const dateKey = formatDateKey(selectedDate);

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/events`), {
                    title,
                    category,
                    date: dateKey,
                    createdAt: Date.now()
                });
                closeModal();
            } catch (err) {
                alert("Error guardando: " + err.message);
            }
        };

        window.deleteEvent = async (id) => {
            if (!currentUser || !confirm("¿Borrar tarea?")) return;
            await deleteDoc(doc(db, `users/${currentUser.uid}/events`, id));
        };

        // --- BALANCEADOR INTELIGENTE (AUTO-MOVE) ---
        window.autoBalanceCalendar = async () => {
            if (!currentUser) return;
            
            const MAX_PER_DAY = 2; // Máximo tareas por día
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // 1. Agrupar eventos por fecha
            const map = {};
            events.forEach(ev => {
                if (!map[ev.date]) map[ev.date] = [];
                map[ev.date].push(ev);
            });

            // 2. Ordenar fechas
            const dates = Object.keys(map).sort((a,b) => {
                const da = new Date(a.split('-')[0], a.split('-')[1], a.split('-')[2]);
                const db = new Date(b.split('-')[0], b.split('-')[1], b.split('-')[2]);
                return da - db;
            });

            const batch = writeBatch(db);
            let movedCount = 0;

            // 3. Iterar fechas
            for (let dStr of dates) {
                const parts = dStr.split('-');
                const currentDateObj = new Date(parts[0], parts[1], parts[2]);

                // SOLO Mover tareas de días FUTUROS (mañana en adelante)
                if (currentDateObj <= today) continue;

                if (map[dStr].length > MAX_PER_DAY) {
                    // Hay sobrecarga
                    const tasks = map[dStr];
                    
                    // Priorizar: Exámenes se quedan, otros se mueven
                    // Ordenar: exams primero
                    tasks.sort((a,b) => (a.category === 'exam' ? -1 : 1));

                    // Los que sobran
                    const toMove = tasks.slice(MAX_PER_DAY);

                    for (let task of toMove) {
                        // Encontrar siguiente hueco libre
                        let nextDate = new Date(currentDateObj);
                        let foundSlot = false;
                        
                        // Buscar en los siguientes 7 días
                        for(let i=0; i<7; i++) {
                            nextDate.setDate(nextDate.getDate() + 1);
                            const nextKey = formatDateKey(nextDate);
                            const countNext = map[nextKey] ? map[nextKey].length : 0;
                            
                            if (countNext < MAX_PER_DAY) {
                                // Mover aquí
                                const ref = doc(db, `users/${currentUser.uid}/events`, task.id);
                                batch.update(ref, { date: nextKey });
                                
                                // Actualizar mapa localmente para siguientes iteraciones
                                if(!map[nextKey]) map[nextKey] = [];
                                map[nextKey].push(task);
                                foundSlot = true;
                                movedCount++;
                                break;
                            }
                        }
                    }
                }
            }

            if (movedCount > 0) {
                await batch.commit();
                alert(`¡Magia! He redistribuido ${movedCount} tareas para que no te agobies.`);
            } else {
                alert("Tu calendario ya está optimizado o no hay huecos libres cercanos.");
            }
        };

        // --- CALENDARIO UI ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            el('monthYear').textContent = `${monthNames[month]} ${year}`;
            el('currentDateDisplay').textContent = new Date().toLocaleDateString('es-ES', {weekday:'short', day:'numeric'});

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = el('calendar-grid');
            grid.innerHTML = '';

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;

            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                const key = formatDateKey(d);
                const isSel = formatDateKey(selectedDate) === key;
                const dayEvents = events.filter(e => e.date === key);
                
                const div = document.createElement('div');
                div.className = `calendar-day flex flex-col items-center justify-center cursor-pointer text-xs rounded-xl h-10 transition-all ${isSel ? 'active' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                
                // Dots logic
                let dots = '';
                if(dayEvents.length > 0) {
                    dots = '<div class="flex mt-1">';
                    const hasExam = dayEvents.some(e => e.category === 'exam');
                    if(hasExam) dots += '<div class="dot exam"></div>';
                    if(dayEvents.length > (hasExam?1:0)) dots += '<div class="dot task"></div>';
                    dots += '</div>';
                }

                div.innerHTML = `<span class="${formatDateKey(new Date())===key && !isSel ? 'text-brand-500 font-bold':''}">${i}</span>${dots}`;
                div.onclick = () => { selectedDate = d; renderCalendar(); renderEvents(); };
                grid.appendChild(div);
            }
        }

        function renderEvents() {
            const key = formatDateKey(selectedDate);
            const dayEvents = events.filter(e => e.date === key);
            
            el('selected-date-title').innerText = selectedDate.getDate();
            el('tasks-subtitle').innerText = new Date().toDateString() === selectedDate.toDateString() ? 'Tareas para hoy' : 'Planificación';
            
            const list = el('event-list');
            list.innerHTML = '';

            // Indicador sobrecarga visual
            const loadIndicator = el('day-load-indicator');
            if (dayEvents.length > 2) {
                loadIndicator.classList.remove('hidden');
            } else {
                loadIndicator.classList.add('hidden');
            }

            if (dayEvents.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-40"><i class="fa-regular fa-calendar-check text-4xl mb-2"></i><p>Todo limpio</p></div>`;
                return;
            }

            dayEvents.forEach(ev => {
                let color = ev.category === 'exam' ? 'red' : (ev.category === 'study' ? 'purple' : 'blue');
                let icon = ev.category === 'exam' ? 'triangle-exclamation' : (ev.category === 'study' ? 'brain' : 'book');
                
                const item = document.createElement('div');
                item.className = `bg-white dark:bg-gray-800 p-4 rounded-2xl flex justify-between items-center shadow-sm border-l-4 border-${color}-500 fade-enter`;
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-${color}-100 text-${color}-600 p-2 rounded-lg"><i class="fa-solid fa-${icon}"></i></div>
                        <div>
                            <div class="font-bold text-sm dark:text-gray-200">${ev.title}</div>
                            <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">${ev.category}</div>
                        </div>
                    </div>
                    <button onclick="deleteEvent('${ev.id}')" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                `;
                list.appendChild(item);
            });
        }

        // --- GLOBAL & INIT ---
        window.openModal = () => { el('event-modal').classList.remove('hidden'); el('event-title').focus(); };
        window.closeModal = () => { el('event-modal').classList.add('hidden'); el('event-form').reset(); };
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            el('theme-icon').classList.toggle('fa-moon');
            el('theme-icon').classList.toggle('fa-sun');
        };

        el('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
        el('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };

        // Start
        renderCalendar();
        renderEvents();

        // Service Worker Fake Registration (Para cumplir estándar PWA)
        if ('serviceWorker' in navigator) {
            // Normalmente aquí iría el registro real, pero al ser un solo archivo no podemos tener sw.js externo fácilmente.
            // El navegador verá el manifest embebido y permitirá "Añadir a pantalla de inicio".
        }
    </script>
</body>
</html>
