<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Student RPG Planner</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiU3R1ZGVudCBSUEciLCJzaG9ydF9uYW1lIjoiQWdlbmRhIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzRmNDZlNSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yOTIxLzI5MjEyMjIucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJdfQ=='>

    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Outfit"', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eef2ff', 100:'#e0e7ff', 500:'#6366f1', 600:'#4f46e5', 900:'#312e81' }, // Indigo
                        accent: { 500:'#ec4899', 600:'#db2777' } // Pink
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1'
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animaciones Personalizadas */
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .dark .glass { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255,255,255,0.05); }
        
        .card-enter { animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .level-bar-bg { position: relative; overflow: hidden; }
        .level-bar-fill { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .calendar-day { transition: all 0.2s; }
        .calendar-day.active { background: #4f46e5; color: white; transform: scale(1.15); box-shadow: 0 4px 15px -3px rgba(79, 70, 229, 0.5); z-index: 10; }
        
        /* Checkbox Animado */
        .check-circle { transition: all 0.3s; }
        .task-row.completed .check-circle { background: #10b981; border-color: #10b981; color: white; transform: scale(1.1); }
        .task-row.completed .task-title { text-decoration: line-through; opacity: 0.6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300 h-screen flex flex-col overflow-hidden selection:bg-brand-500 selection:text-white">

    <!-- LOGIN -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-white dark:bg-gray-900 flex flex-col items-center justify-center p-6 text-center transition-all duration-500">
        <div class="w-32 h-32 bg-gradient-to-tr from-brand-500 to-accent-500 rounded-[2rem] flex items-center justify-center shadow-2xl mb-8 animate-bounce-short">
            <i class="fa-solid fa-gamepad text-5xl text-white"></i>
        </div>
        <h1 class="text-4xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-accent-600">Level Up!</h1>
        <p class="text-gray-500 mb-12 text-lg">Tu agenda gamificada.</p>
        <button onclick="loginWithGoogle()" class="w-full max-w-xs bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 p-4 rounded-2xl flex items-center justify-center gap-4 font-bold text-lg shadow-lg hover:scale-105 transition-transform active:scale-95 group">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 group-hover:rotate-12 transition">
            <span>Entrar con Google</span>
        </button>
    </div>

    <!-- APP -->
    <div id="app-content" class="flex flex-col h-full hidden opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER & LEVEL -->
        <header class="px-6 pt-6 pb-2 bg-white dark:bg-gray-900 z-10">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img id="user-avatar" src="" class="w-10 h-10 rounded-full border-2 border-brand-500 p-0.5" alt="User">
                        <div class="absolute -bottom-1 -right-1 bg-brand-600 text-white text-[10px] font-bold px-1.5 rounded-md border border-white dark:border-gray-900">
                            Lvl <span id="user-level">1</span>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold leading-none dark:text-white">Mi Agenda</h1>
                        <div class="text-xs text-brand-500 font-semibold mt-1 flex items-center gap-1">
                            <span id="xp-display">0 XP</span>
                            <span class="text-gray-300">|</span>
                            <span id="next-level-xp">100 para Lvl 2</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="autoBalanceCalendar()" class="w-10 h-10 rounded-full bg-accent-50 dark:bg-accent-900/20 text-accent-500 flex items-center justify-center hover:bg-accent-100 transition relative">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <span id="balance-badge" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <button onclick="logout()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500 flex items-center justify-center hover:text-red-500 transition">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>

            <!-- BARRA XP -->
            <div class="h-2 w-full bg-gray-100 dark:bg-gray-800 rounded-full level-bar-bg">
                <div id="xp-bar" class="h-full bg-gradient-to-r from-brand-400 to-accent-500 rounded-full level-bar-fill" style="width: 0%"></div>
            </div>

            <!-- WIDGET PRÓXIMO EXAMEN -->
            <div id="exam-widget" class="mt-4 hidden card-enter">
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white p-4 rounded-2xl shadow-xl flex justify-between items-center relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-white/5 rounded-full -mr-10 -mt-10 blur-xl"></div>
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-gray-400 font-bold mb-1">Próximo Reto</p>
                        <h3 id="next-exam-title" class="font-bold text-lg leading-tight">Matemáticas</h3>
                        <p id="next-exam-date" class="text-xs text-gray-400">Viernes, 12 Oct</p>
                    </div>
                    <div class="text-center z-10 bg-white/10 rounded-lg p-2 backdrop-blur-sm min-w-[60px]">
                        <span id="days-left" class="block text-2xl font-extrabold text-accent-400">3</span>
                        <span class="text-[10px] font-bold uppercase">Días</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- CALENDARIO & TAREAS -->
        <main class="flex-1 overflow-y-auto no-scrollbar pb-24 relative rounded-t-[2.5rem] mt-4 bg-gray-50 dark:bg-gray-800/50 pt-6">
            
            <!-- Calendario -->
            <div class="px-6 mb-2 flex justify-between items-center">
                <h2 id="monthYear" class="text-xl font-bold capitalize text-gray-700 dark:text-gray-200"></h2>
                <div class="flex gap-2">
                    <button id="prevMonth" class="p-2 hover:bg-white dark:hover:bg-gray-700 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <button id="nextMonth" class="p-2 hover:bg-white dark:hover:bg-gray-700 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-7 text-center px-4 mb-2">
                <span class="text-[10px] font-bold text-gray-400">D</span><span class="text-[10px] font-bold text-gray-400">L</span><span class="text-[10px] font-bold text-gray-400">M</span><span class="text-[10px] font-bold text-gray-400">X</span><span class="text-[10px] font-bold text-gray-400">J</span><span class="text-[10px] font-bold text-gray-400">V</span><span class="text-[10px] font-bold text-gray-400">S</span>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-y-3 gap-x-1 px-4 mb-8"></div>

            <!-- Lista Tareas -->
            <div class="px-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="selected-date-title" class="font-bold text-xl dark:text-white">Hoy</h3>
                    <span id="task-counter" class="text-xs font-bold bg-white dark:bg-gray-700 px-2 py-1 rounded-lg text-gray-500 shadow-sm">0 Tareas</span>
                </div>
                <div id="event-list" class="space-y-3 pb-24 min-h-[200px]"></div>
            </div>
        </main>

        <!-- FAB -->
        <button onclick="openModal()" class="fixed bottom-6 right-6 bg-brand-600 hover:bg-brand-500 text-white w-14 h-14 rounded-full shadow-lg shadow-brand-500/40 flex items-center justify-center text-2xl transition-all hover:scale-110 active:scale-95 z-40 group">
            <i class="fa-solid fa-plus group-hover:rotate-90 transition-transform duration-300"></i>
        </button>

        <!-- MODAL ADD -->
        <div id="event-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-end sm:items-center justify-center sm:p-4">
            <div class="bg-white dark:bg-gray-800 w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl card-enter">
                <h3 class="text-2xl font-bold mb-6 dark:text-white">Nueva Misión</h3>
                <form id="event-form" onsubmit="handleSave(event)">
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded-2xl mb-4 border-2 border-transparent focus-within:border-brand-500 transition-colors">
                        <input type="text" id="event-title" required class="w-full bg-transparent border-0 p-2 text-lg font-semibold focus:ring-0 dark:text-white placeholder-gray-400" placeholder="Ej: Estudiar Matemáticas">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-8">
                        <label class="cursor-pointer group">
                            <input type="radio" name="category" value="exam" class="peer hidden" checked>
                            <div class="peer-checked:bg-red-500 peer-checked:text-white bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-2xl p-4 text-center transition-all group-hover:bg-gray-200 dark:group-hover:bg-gray-600">
                                <i class="fa-solid fa-skull block text-2xl mb-2"></i>
                                <span class="text-xs font-bold uppercase tracking-wider">Examen</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="category" value="homework" class="peer hidden">
                            <div class="peer-checked:bg-brand-500 peer-checked:text-white bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-2xl p-4 text-center transition-all group-hover:bg-gray-200 dark:group-hover:bg-gray-600">
                                <i class="fa-solid fa-scroll block text-2xl mb-2"></i>
                                <span class="text-xs font-bold uppercase tracking-wider">Deberes</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="category" value="study" class="peer hidden">
                            <div class="peer-checked:bg-accent-500 peer-checked:text-white bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-2xl p-4 text-center transition-all group-hover:bg-gray-200 dark:group-hover:bg-gray-600">
                                <i class="fa-solid fa-brain block text-2xl mb-2"></i>
                                <span class="text-xs font-bold uppercase tracking-wider">Repaso</span>
                            </div>
                        </label>
                    </div>

                    <div class="flex gap-3">
                        <button type="button" onclick="closeModal()" class="flex-1 bg-transparent hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 py-4 rounded-xl font-bold transition">Cancelar</button>
                        <button type="submit" class="flex-[2] bg-brand-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-brand-500/30 hover:bg-brand-500 transition relative overflow-hidden">
                            <span class="relative z-10">Aceptar Misión</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG (NO TOCAR)
        const firebaseConfig = {
            apiKey: "AIzaSyDPEsl_dE1fzYkuxemJRvhDxpfvYZfgGZo",
            authDomain: "calendar-1868c.firebaseapp.com",
            projectId: "calendar-1868c",
            storageBucket: "calendar-1868c.firebasestorage.app",
            messagingSenderId: "872239833100",
            appId: "1:872239833100:web:b9059b5f589825f2950e29",
            measurementId: "G-RRR30MYKXW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let events = [];
        let currentDate = new Date();
        let selectedDate = new Date();
        let unsubscribe = null;

        // --- AUTH ---
        window.loginWithGoogle = async () => {
            try { await signInWithPopup(auth, provider); } 
            catch (e) { alert("Error: " + e.message); }
        };

        window.logout = () => {
            if(confirm("¿Cerrar sesión?")) {
                signOut(auth);
                location.reload();
            }
        };

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('login-overlay');
            const content = document.getElementById('app-content');
            
            if (user) {
                currentUser = user;
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.add('hidden'), 500);
                content.classList.remove('hidden');
                setTimeout(() => content.style.opacity = '1', 100);
                document.getElementById('user-avatar').src = user.photoURL;
                initSync();
            } else {
                overlay.classList.remove('hidden');
                overlay.style.opacity = '1';
                content.classList.add('hidden');
            }
        });

        // --- CORE LOGIC ---
        function initSync() {
            const q = query(collection(db, `users/${currentUser.uid}/events`));
            unsubscribe = onSnapshot(q, (snapshot) => {
                events = [];
                snapshot.forEach(doc => events.push({ id: doc.id, ...doc.data() }));
                refreshUI();
            });
        }

        function refreshUI() {
            renderCalendar();
            renderEvents();
            updateGamification();
            updateExamWidget();
            checkBalanceNeed();
        }

        // --- RPG & GAMIFICATION ---
        function updateGamification() {
            // XP = Tareas completadas * 10
            const completedCount = events.filter(e => e.completed).length;
            const currentXP = completedCount * 10;
            const level = Math.floor(currentXP / 100) + 1;
            const nextLevelXP = level * 100;
            const progress = ((currentXP % 100) / 100) * 100;

            document.getElementById('user-level').innerText = level;
            document.getElementById('xp-display').innerText = `${currentXP} XP`;
            document.getElementById('next-level-xp').innerText = `${nextLevelXP - currentXP} para Lvl ${level+1}`;
            document.getElementById('xp-bar').style.width = `${progress}%`;
        }

        function updateExamWidget() {
            const now = new Date();
            now.setHours(0,0,0,0);
            
            // Buscar examen futuro más cercano
            const upcomingExams = events
                .filter(e => e.category === 'exam' && !e.completed)
                .map(e => {
                    const parts = e.date.split('-');
                    const d = new Date(parts[0], parts[1], parts[2]);
                    return { ...e, dateObj: d };
                })
                .filter(e => e.dateObj >= now)
                .sort((a,b) => a.dateObj - b.dateObj);

            const widget = document.getElementById('exam-widget');
            
            if (upcomingExams.length > 0) {
                const exam = upcomingExams[0];
                const diffTime = Math.abs(exam.dateObj - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                document.getElementById('next-exam-title').innerText = exam.title;
                document.getElementById('next-exam-date').innerText = exam.dateObj.toLocaleDateString('es-ES', {weekday:'long', day:'numeric'});
                document.getElementById('days-left').innerText = diffDays;
                
                // Color alert
                const daysSpan = document.getElementById('days-left');
                if (diffDays <= 2) daysSpan.className = "block text-2xl font-extrabold text-red-500 animate-pulse";
                else if (diffDays <= 5) daysSpan.className = "block text-2xl font-extrabold text-orange-400";
                else daysSpan.className = "block text-2xl font-extrabold text-green-400";

                widget.classList.remove('hidden');
            } else {
                widget.classList.add('hidden');
            }
        }

        // --- CRUD & ACTIONS ---
        window.handleSave = async (e) => {
            e.preventDefault();
            const title = document.getElementById('event-title').value;
            const category = document.querySelector('input[name="category"]:checked').value;
            
            await addDoc(collection(db, `users/${currentUser.uid}/events`), {
                title, category,
                date: formatDateKey(selectedDate),
                completed: false,
                createdAt: Date.now()
            });
            window.closeModal();
            
            // Sonido o efecto sutil (Opcional)
        };

        window.toggleComplete = async (id, currentStatus) => {
            const ref = doc(db, `users/${currentUser.uid}/events`, id);
            await updateDoc(ref, { completed: !currentStatus });
            
            if (!currentStatus) {
                // Trigger Confetti!
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#4f46e5', '#ec4899', '#ffffff']
                });
            }
        };

        window.deleteEvent = async (id) => {
            if(confirm("¿Eliminar definitivamente?")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/events`, id));
            }
        };

        // --- AUTO BALANCEADOR MEJORADO ---
        function checkBalanceNeed() {
            // Check si hay días sobrecargados (>2 tareas activas)
            const map = {};
            events.filter(e => !e.completed).forEach(e => {
                map[e.date] = (map[e.date] || 0) + 1;
            });
            const overloaded = Object.values(map).some(count => count > 2);
            const badge = document.getElementById('balance-badge');
            if (overloaded) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        window.autoBalanceCalendar = async () => {
            const today = new Date(); today.setHours(0,0,0,0);
            const batch = writeBatch(db);
            let moved = 0;
            
            // Mapa de carga actual
            const loadMap = {};
            events.forEach(e => { if(!e.completed) loadMap[e.date] = (loadMap[e.date]||[]).concat(e); });

            // Iterar fechas ordenadas
            const sortedDates = Object.keys(loadMap).sort();

            for (const dStr of sortedDates) {
                const parts = dStr.split('-');
                const dObj = new Date(parts[0], parts[1], parts[2]);
                
                if (dObj <= today) continue; // Solo futuro
                if (loadMap[dStr].length > 2) {
                    const tasks = loadMap[dStr].sort((a,b) => (a.category==='exam'?-1:1)); // Examen primero
                    const toMove = tasks.slice(2); // Mover lo que sobre de 2

                    for (const task of toMove) {
                        // Buscar hueco
                        let nextD = new Date(dObj);
                        for(let i=0; i<5; i++) { // Mirar próximos 5 días
                            nextD.setDate(nextD.getDate()+1);
                            const k = formatDateKey(nextD);
                            const currentLoad = (loadMap[k]||[]).length;
                            if (currentLoad < 2) {
                                batch.update(doc(db,`users/${currentUser.uid}/events`, task.id), { date: k });
                                // Actualizar mapa virtual
                                if(!loadMap[k]) loadMap[k]=[];
                                loadMap[k].push(task);
                                moved++;
                                break;
                            }
                        }
                    }
                }
            }

            if(moved > 0) {
                if(confirm(`He encontrado ${moved} tareas que causan estrés. ¿Las redistribuyo automáticamente?`)) {
                    await batch.commit();
                    confetti({ particleCount: 50, spread: 100, origin: { y: 0.6 } });
                }
            } else {
                alert("Tu calendario está perfectamente equilibrado. ¡Bien hecho!");
            }
        };

        // --- UI HELPERS ---
        const formatDateKey = (d) => `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        
        function renderCalendar() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            document.getElementById('monthYear').innerText = new Date(y, m).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

            for(let i=1; i<=daysInMonth; i++) {
                const d = new Date(y, m, i);
                const k = formatDateKey(d);
                const dayEvents = events.filter(e => e.date === k && !e.completed); // Solo contar pendientes para los puntos
                const isSelected = formatDateKey(selectedDate) === k;
                const isToday = formatDateKey(new Date()) === k;

                const div = document.createElement('div');
                div.className = `calendar-day flex flex-col items-center justify-center h-10 w-10 mx-auto rounded-xl cursor-pointer text-sm font-medium ${isSelected ? 'active' : 'hover:bg-gray-200 dark:hover:bg-gray-700 dark:text-gray-300'}`;
                if(isToday && !isSelected) div.classList.add('text-brand-500', 'font-bold', 'border', 'border-brand-200');

                let dots = '';
                if(dayEvents.length > 0) {
                    const hasExam = dayEvents.some(e => e.category === 'exam');
                    dots = `<div class="flex gap-0.5 mt-0.5"><div class="w-1 h-1 rounded-full ${hasExam ? 'bg-red-500':'bg-brand-400'}"></div></div>`;
                }

                div.innerHTML = `<span>${i}</span>${dots}`;
                div.onclick = () => { selectedDate = d; renderCalendar(); renderEvents(); };
                grid.appendChild(div);
            }
        }

        function renderEvents() {
            const k = formatDateKey(selectedDate);
            const dayEvents = events.filter(e => e.date === k).sort((a,b) => a.completed - b.completed); // Completadas al final
            
            const dateTitle = selectedDate.toLocaleDateString('es-ES', {weekday:'long', day:'numeric'});
            document.getElementById('selected-date-title').innerText = formatDateKey(new Date())===k ? 'Hoy' : dateTitle;
            document.getElementById('task-counter').innerText = `${dayEvents.length} Tareas`;

            const list = document.getElementById('event-list');
            list.innerHTML = '';

            if(dayEvents.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-10 opacity-50 flex flex-col items-center">
                        <i class="fa-solid fa-mug-hot text-4xl mb-3 text-gray-300"></i>
                        <p class="text-sm">Día libre. ¡Disfruta!</p>
                    </div>`;
                return;
            }

            dayEvents.forEach(ev => {
                const isExam = ev.category === 'exam';
                const color = isExam ? 'red' : (ev.category === 'study' ? 'purple' : 'indigo');
                const icon = isExam ? 'skull' : (ev.category === 'study' ? 'brain' : 'book');
                
                const div = document.createElement('div');
                div.className = `task-row glass p-4 rounded-2xl flex items-center justify-between shadow-sm card-enter mb-3 ${ev.completed ? 'completed opacity-60 grayscale' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div onclick="toggleComplete('${ev.id}', ${ev.completed})" class="check-circle w-6 h-6 rounded-full border-2 border-gray-300 cursor-pointer flex items-center justify-center hover:border-brand-500 transition">
                            ${ev.completed ? '<i class="fa-solid fa-check text-xs"></i>' : ''}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm dark:text-gray-100 task-title">${ev.title}</h4>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-${color}-100 text-${color}-600 uppercase tracking-wide">${ev.category}</span>
                        </div>
                    </div>
                    ${ev.completed ? 
                        `<button onclick="deleteEvent('${ev.id}')" class="text-gray-400 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>` : 
                        `<i class="fa-solid fa-${icon} text-gray-200 text-2xl"></i>`
                    }
                `;
                list.appendChild(div);
            });
        }

        // --- GLOBAL EXPORTS ---
        window.openModal = () => document.getElementById('event-modal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('event-modal').classList.add('hidden');
        document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
        
        // Initial Render
        renderCalendar();
    </script>
</body>
</html>
